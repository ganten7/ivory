name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pyqt5 python3-pyqt5.qtsvg

      - name: Install Python dependencies
        run: |
          pip install -r requirements_pyqt5.txt

      - name: Build .deb package
        run: |
          mkdir -p build-deb/DEBIAN
          mkdir -p build-deb/usr/bin
          mkdir -p build-deb/usr/share/applications
          mkdir -p build-deb/usr/share/icons/hicolor/{16x16,32x32,48x48,64x64,128x128}/apps
          mkdir -p build-deb/usr/share/doc/ivory

          # Copy files
          cp ivory.py build-deb/usr/bin/ivory
          cp chord_detector.py build-deb/usr/bin/
          chmod +x build-deb/usr/bin/ivory
          cp icons/ivory.png build-deb/usr/share/icons/hicolor/128x128/apps/

          # Create desktop file
          cat > build-deb/usr/share/applications/ivory.desktop << EOF
          [Desktop Entry]
          Version=1.0
          Name=Ivory
          GenericName=MIDI Keyboard Monitor
          Comment=Simple MIDI Keyboard Monitor with Advanced Chord Detection
          Exec=ivory
          Icon=ivory
          Terminal=false
          Type=Application
          StartupWMClass=Ivory
          StartupNotify=true
          Categories=AudioVideo;Audio;MIDI;Music;
          Keywords=midi;keyboard;piano;music;chord;detection;ivory;monitor;88-key;visualizer;
          X-GNOME-UsesNotifications=false
          EOF

          # Create control file
          # Extract version from tag, or use default for manual runs
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION=$(echo $GITHUB_REF | sed 's/refs\/tags\/v//')
          else
            VERSION="1.0.0"
          fi
          cat > build-deb/DEBIAN/control << EOF
          Package: ivory
          Version: ${VERSION}
          Section: sound
          Priority: optional
          Architecture: all
          Depends: python3 (>= 3.6), python3-pyqt5, python3-pyqt5.qtsvg
          Maintainer: Ganten <ganten7@github.com>
          Description: Simple MIDI Keyboard Monitor with Advanced Chord Detection
           Ivory provides real-time visualization of all 88 piano keys with intelligent
           chord recognition supporting triads, 7th chords, extensions, alterations,
           inversions, and slash chords.
          Homepage: https://github.com/ganten7/ivory
          EOF

          # Build package
          dpkg-deb --build build-deb ivory_${VERSION:-1.0.0}_all.deb

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ivory-linux
          path: ivory_*.deb

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements_pyqt5.txt
          pip install pyinstaller

      - name: Build executable with PyInstaller
        shell: pwsh
        run: |
          python -m PyInstaller --onefile --windowed --name ivory `
            --clean `
            --noupx `
            --noconfirm `
            --hidden-import chord_detector `
            --collect-submodules chord_detector `
            --hidden-import PyQt5.QtCore `
            --hidden-import PyQt5.QtGui `
            --hidden-import PyQt5.QtWidgets `
            --hidden-import PyQt5.QtWidgets.QApplication `
            --hidden-import PyQt5.sip `
            --hidden-import mido `
            --hidden-import mido.backends.rtmidi `
            --hidden-import rtmidi `
            --collect-all mido `
            --collect-all rtmidi `
            --exclude-module tkinter `
            --exclude-module matplotlib `
            --exclude-module numpy `
            --exclude-module scipy `
            --exclude-module pandas `
            ivory.py
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "PyInstaller failed, checking output..."
            if (Test-Path "build/ivory/warn-ivory.txt") {
              Get-Content "build/ivory/warn-ivory.txt"
            }
            if (Test-Path "build/ivory") {
              Get-ChildItem "build/ivory" -Recurse | Select-Object FullName
            }
            exit 1
          }
          
          if (-not (Test-Path "dist/ivory.exe")) {
            Write-Host "Error: ivory.exe not found in dist/"
            Get-ChildItem "dist/" | Select-Object Name
            exit 1
          }
          
          # Verify it's a valid PE executable (not Node.js)
          Write-Host "Verifying executable..."
          file dist/ivory.exe || Get-Item dist/ivory.exe | Select-Object Length, LastWriteTime

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ivory-windows
          path: dist/ivory.exe

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements_pyqt5.txt
          pip install pyinstaller

      - name: Build .app bundle
        run: |
          # Clean any previous builds to avoid symlink conflicts
          rm -rf build/Ivory dist/Ivory Ivory.app 2>/dev/null || true
          
          # Create hooks directory for PyInstaller
          mkdir -p hooks
          # Copy hook file if it exists
          if [ -f "hook-PyQt5.QtBluetooth.py" ]; then
            cp hook-PyQt5.QtBluetooth.py hooks/
          fi
          
          # PyInstaller with --windowed creates .app bundle automatically
          # Skip icon for now (requires PIL/Pillow and can cause issues)
          # Use targeted imports - PyInstaller auto-detects frameworks for hidden imports
          # Use --additional-hooks-dir to use our custom hook
          python -m PyInstaller --onedir --windowed --name Ivory \
            --additional-hooks-dir=hooks \
            --add-data "icons:icons" \
            --hidden-import chord_detector \
            --hidden-import PyQt5.QtCore \
            --hidden-import PyQt5.QtGui \
            --hidden-import PyQt5.QtWidgets \
            --hidden-import PyQt5.sip \
            --hidden-import mido \
            --hidden-import mido.backends.rtmidi \
            --hidden-import rtmidi \
            --collect-all mido \
            --collect-all rtmidi \
            --exclude-module tkinter \
            --exclude-module matplotlib \
            --exclude-module numpy \
            --exclude-module scipy \
            --exclude-module pandas \
            --exclude-module PyQt5.QtBluetooth \
            --exclude-module PyQt5.QtNfc \
            --exclude-module PyQt5.QtWebSockets \
            --exclude-module PyQt5.QtWebEngine \
            --exclude-module PyQt5.QtWebEngineWidgets \
            --exclude-module PyQt5.QtQuick \
            --exclude-module PyQt5.QtQml \
            --exclude-module PyQt5.Qt3D \
            --exclude-module PyQt5.QtGamepad \
            --exclude-module PyQt5.QtLocation \
            --exclude-module PyQt5.QtPositioning \
            --noconfirm \
            ivory.py 2>&1 | tee pyinstaller.log || {
            # Check if it's the QtBluetooth symlink conflict
            if grep -q "FileExistsError.*QtBluetooth\|File exists.*Versions/Current/Resources" pyinstaller.log; then
              echo "QtBluetooth framework symlink conflict - attempting workaround..."
              # Remove problematic frameworks before they cause issues
              find dist/Ivory -name "QtBluetooth.framework" -type d -exec rm -rf {} + 2>/dev/null || true
              find dist/Ivory -name "QtNfc.framework" -type d -exec rm -rf {} + 2>/dev/null || true
              find dist/Ivory -name "QtWebEngine*.framework" -type d -exec rm -rf {} + 2>/dev/null || true
              # If we have dist/Ivory, try to manually complete the .app bundle
              if [ -d "dist/Ivory" ] && [ -f "dist/Ivory/Ivory" ]; then
                echo "Found dist/Ivory with executable, attempting manual .app bundle creation..."
                # Create .app structure manually
                mkdir -p dist/Ivory.app/Contents/MacOS
                mkdir -p dist/Ivory.app/Contents/Frameworks
                mkdir -p dist/Ivory.app/Contents/Resources
                # Copy executable
                cp dist/Ivory/Ivory dist/Ivory.app/Contents/MacOS/
                # Copy _internal directory (contains Python and libraries)
                if [ -d "dist/Ivory/_internal" ]; then
                  cp -r dist/Ivory/_internal dist/Ivory.app/Contents/MacOS/
                fi
                # Copy frameworks if they exist
                if [ -d "dist/Ivory/_internal/PyQt5/Qt5/lib" ]; then
                  # Copy only essential frameworks, skip problematic ones
                  for fw in QtCore QtGui QtWidgets; do
                    if [ -d "dist/Ivory/_internal/PyQt5/Qt5/lib/${fw}.framework" ]; then
                      cp -r "dist/Ivory/_internal/PyQt5/Qt5/lib/${fw}.framework" dist/Ivory.app/Contents/Frameworks/ 2>/dev/null || true
                    fi
                  done
                fi
                # Create minimal Info.plist using defaults command (macOS built-in)
                defaults write dist/Ivory.app/Contents/Info CFBundleExecutable -string Ivory
                defaults write dist/Ivory.app/Contents/Info CFBundleIdentifier -string com.github.ganten7.ivory
                defaults write dist/Ivory.app/Contents/Info CFBundleName -string Ivory
                defaults write dist/Ivory.app/Contents/Info CFBundleVersion -string 1.0.0
                defaults write dist/Ivory.app/Contents/Info CFBundleShortVersionString -string 1.0.0
                defaults write dist/Ivory.app/Contents/Info LSMinimumSystemVersion -string 10.13
                defaults write dist/Ivory.app/Contents/Info NSHighResolutionCapable -bool true
                plutil -convert xml1 dist/Ivory.app/Contents/Info.plist
                echo "Manually created .app bundle"
              else
                echo "PyInstaller failed and dist/Ivory not usable"
                tail -100 pyinstaller.log || true
                exit 1
              fi
            else
              echo "PyInstaller failed with different error"
              echo "=== PyInstaller log ==="
              tail -100 pyinstaller.log || true
              echo "=== Build directory ==="
              ls -la build/ || true
              if [ -d "build/Ivory" ]; then
                echo "=== Build warnings ==="
                cat build/Ivory/warn-Ivory.txt || true
              fi
              echo "=== Dist directory ==="
              ls -la dist/ || true
              exit 1
            fi
          }
          
          # Move the .app bundle to current directory
          if [ -d "dist/Ivory.app" ]; then
            mv dist/Ivory.app .
            
            # Verify .app bundle structure
            echo "Verifying .app bundle structure..."
            if [ ! -d "Ivory.app/Contents/MacOS" ]; then
              echo "ERROR: Contents/MacOS directory missing!"
              exit 1
            fi
            
            # Find the executable
            EXECUTABLE=$(find Ivory.app/Contents/MacOS -type f -perm +111 | head -1)
            if [ -z "$EXECUTABLE" ]; then
              echo "ERROR: No executable found in Ivory.app/Contents/MacOS"
              ls -la Ivory.app/Contents/MacOS/ || true
              exit 1
            fi
            
            echo "Found executable: $EXECUTABLE"
            
            # Ensure executable has correct permissions
            chmod +x "$EXECUTABLE" || true
            
            # Verify Info.plist exists (PyInstaller should create it, but verify)
            if [ ! -f "Ivory.app/Contents/Info.plist" ]; then
              echo "WARNING: Info.plist missing, PyInstaller should have created it"
              echo "This may indicate a build issue"
            fi
            
            # Remove quarantine attribute (helps with Gatekeeper)
            xattr -cr Ivory.app || true
            
            # Test that we can at least see the executable
            if [ -x "$EXECUTABLE" ]; then
              echo "✓ Executable is executable and found at: $EXECUTABLE"
              echo "✓ Ivory.app structure verified"
              
              # Check for PyQt5 frameworks
              if [ -d "Ivory.app/Contents/Frameworks" ]; then
                echo "✓ Frameworks directory exists"
                echo "Frameworks found:"
                ls -la Ivory.app/Contents/Frameworks/ | head -10 || true
              else
                echo "WARNING: Frameworks directory missing!"
              fi
              
              # Check Info.plist
              if [ -f "Ivory.app/Contents/Info.plist" ]; then
                echo "✓ Info.plist exists"
                echo "CFBundleExecutable in Info.plist:"
                grep -A 1 "CFBundleExecutable" Ivory.app/Contents/Info.plist || true
              else
                echo "WARNING: Info.plist missing!"
              fi
              
              # Try to get executable info (won't run it, just check it exists)
              echo "=== Executable file info ==="
              file "$EXECUTABLE" || true
              echo ""
              echo "=== Executable linked libraries (first 30) ==="
              otool -L "$EXECUTABLE" | head -30 || true
              echo ""
              
              # Check if PyQt5 frameworks are linked
              if otool -L "$EXECUTABLE" | grep -q "PyQt5\|Qt"; then
                echo "✓ PyQt5/Qt libraries found in executable"
              else
                echo "WARNING: No PyQt5/Qt libraries found in executable!"
              fi
              
              # List all files in MacOS directory
              echo ""
              echo "=== Contents of MacOS directory ==="
              ls -la Ivory.app/Contents/MacOS/ || true
            else
              echo "ERROR: Executable is not executable!"
              exit 1
            fi
          else
            echo "Error: Ivory.app not found in dist/"
            echo "Contents of dist/:"
            ls -la dist/ || true
            echo "Contents of build/:"
            ls -la build/ || true
            exit 1
          fi

      - name: Create ZIP archive
        run: |
          # Create ZIP file - simpler than DMG, no mounting needed
          zip -r Ivory.zip Ivory.app
          echo "✓ Created Ivory.zip"

      - name: Create DMG (optional, for users who prefer DMG)
        run: |
          # Also create DMG for users who prefer it
          hdiutil create -volname "Ivory" -srcfolder Ivory.app -ov -format UDZO Ivory.dmg || echo "DMG creation failed, continuing with ZIP only"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ivory-macos
          path: |
            Ivory.zip
            Ivory.dmg

  release:
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v3

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: ivory-linux
          path: ivory-linux

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: ivory-windows
          path: ivory-windows

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: ivory-macos
          path: ivory-macos

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          find . -type f \( -name "*.deb" -o -name "*.exe" -o -name "*.dmg" \) | head -20
          ls -la ivory-*/ || true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ivory-linux/*.deb
            ivory-windows/*.exe
            ivory-macos/*.zip
            ivory-macos/*.dmg
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
