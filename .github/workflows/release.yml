name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pyqt5 python3-pyqt5.qtsvg

      - name: Install Python dependencies
        run: |
          pip install -r requirements_pyqt5.txt

      - name: Build .deb package
        run: |
          mkdir -p build-deb/DEBIAN
          mkdir -p build-deb/usr/bin
          mkdir -p build-deb/usr/share/applications
          mkdir -p build-deb/usr/share/icons/hicolor/{16x16,32x32,48x48,64x64,128x128}/apps
          mkdir -p build-deb/usr/share/doc/ivory

          # Copy files
          cp ivory.py build-deb/usr/bin/ivory
          cp chord_detector.py build-deb/usr/bin/
          chmod +x build-deb/usr/bin/ivory
          cp icons/ivory.png build-deb/usr/share/icons/hicolor/128x128/apps/

          # Create desktop file
          cat > build-deb/usr/share/applications/ivory.desktop << EOF
          [Desktop Entry]
          Version=1.0
          Name=Ivory
          GenericName=MIDI Keyboard Monitor
          Comment=Simple MIDI Keyboard Monitor with Advanced Chord Detection
          Exec=ivory
          Icon=ivory
          Terminal=false
          Type=Application
          StartupWMClass=Ivory
          StartupNotify=true
          Categories=AudioVideo;Audio;MIDI;Music;
          Keywords=midi;keyboard;piano;music;chord;detection;ivory;monitor;88-key;visualizer;
          X-GNOME-UsesNotifications=false
          EOF

          # Create control file
          VERSION=$(echo $GITHUB_REF | sed 's/refs\/tags\/v//')
          cat > build-deb/DEBIAN/control << EOF
          Package: ivory
          Version: ${VERSION:-1.0.0}
          Section: sound
          Priority: optional
          Architecture: all
          Depends: python3 (>= 3.6), python3-pyqt5, python3-pyqt5.qtsvg
          Maintainer: Ganten <ganten7@github.com>
          Description: Simple MIDI Keyboard Monitor with Advanced Chord Detection
           Ivory provides real-time visualization of all 88 piano keys with intelligent
           chord recognition supporting triads, 7th chords, extensions, alterations,
           inversions, and slash chords.
          Homepage: https://github.com/ganten7/ivory
          EOF

          # Build package
          dpkg-deb --build build-deb ivory_${VERSION:-1.0.0}_all.deb

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ivory-linux
          path: ivory_*.deb

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements_pyqt5.txt
          pip install pyinstaller

      - name: Build executable with PyInstaller
        run: |
          pyinstaller --onefile --windowed --name ivory --icon=icons/ivory.png --add-data "chord_detector.py;." ivory.py

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ivory-windows
          path: dist/ivory.exe

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements_pyqt5.txt
          pip install pyinstaller

      - name: Build .app bundle
        run: |
          pyinstaller --onefile --windowed --name Ivory --icon=icons/ivory.png --add-data "chord_detector.py:." ivory.py
          # Create .app bundle structure
          mkdir -p Ivory.app/Contents/MacOS
          mkdir -p Ivory.app/Contents/Resources
          cp dist/Ivory Ivory.app/Contents/MacOS/
          cp icons/ivory.png Ivory.app/Contents/Resources/
          
          # Create Info.plist
          cat > Ivory.app/Contents/Info.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleExecutable</key>
            <string>Ivory</string>
            <key>CFBundleIconFile</key>
            <string>ivory.png</string>
            <key>CFBundleIdentifier</key>
            <string>com.github.ganten7.ivory</string>
            <key>CFBundleName</key>
            <string>Ivory</string>
            <key>CFBundleVersion</key>
            <string>1.0.0</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0.0</string>
            <key>LSMinimumSystemVersion</key>
            <string>10.13</string>
            <key>NSHighResolutionCapable</key>
            <true/>
          </dict>
          </plist>
          EOF

      - name: Create DMG
        run: |
          # Create DMG using hdiutil
          hdiutil create -volname "Ivory" -srcfolder Ivory.app -ov -format UDZO Ivory.dmg

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ivory-macos
          path: Ivory.dmg

  release:
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v3

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ivory-linux/*.deb
            ivory-windows/*.exe
            ivory-macos/*.dmg
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
