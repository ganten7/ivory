name: Build and Release

on:
  push:
    tags:
      - 'v*.*'

permissions:
  contents: write

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            build_command: |
              mkdir -p dist
              mkdir -p build-deb/DEBIAN
              mkdir -p build-deb/usr/bin
              mkdir -p build-deb/usr/share/applications
              mkdir -p build-deb/usr/share/icons/hicolor/128x128/apps
              mkdir -p build-deb/usr/share/doc/ivory
              
              # Copy files
              cp ivory_v2.py build-deb/usr/bin/ivory
              cp chord_detector_v2.py build-deb/usr/bin/
              chmod +x build-deb/usr/bin/ivory
              
              # Copy icon if it exists
              if [ -d "icons" ] && [ -f "icons/ivory.png" ]; then
                cp icons/ivory.png build-deb/usr/share/icons/hicolor/128x128/apps/
              fi
              
              # Create desktop file
              cat > build-deb/usr/share/applications/ivory.desktop << EOF
              [Desktop Entry]
              Version=${VERSION}
              Name=Ivory
              GenericName=MIDI Keyboard Monitor
              Comment=Simple MIDI Keyboard Monitor with Advanced Chord Detection
              Exec=ivory
              Icon=ivory
              Terminal=false
              Type=Application
              StartupWMClass=Ivory
              StartupNotify=true
              Categories=AudioVideo;Audio;MIDI;Music;
              Keywords=midi;keyboard;piano;music;chord;detection;ivory;monitor;88-key;visualizer;
              X-GNOME-UsesNotifications=false
              EOF
              
              # Create control file
              cat > build-deb/DEBIAN/control << EOF
              Package: ivory
              Version: ${VERSION}
              Section: sound
              Priority: optional
              Architecture: all
              Depends: python3 (>= 3.6), python3-pyqt5, python3-pyqt5.qtsvg
              Maintainer: Ganten <ganten7@github.com>
              Description: Simple MIDI Keyboard Monitor with Advanced Chord Detection
               Ivory provides real-time visualization of all 88 piano keys with intelligent
               chord recognition supporting triads, 7th chords, extensions, alterations,
               inversions, and slash chords.
              Homepage: https://github.com/ganten7/ivory
              EOF
              
              # Build package
              dpkg-deb --build build-deb ivory_${VERSION}_all.deb
              mv ivory_${VERSION}_all.deb dist/

          - os: windows-latest
            platform: windows
            build_command: |
              pip install -r build_scripts/requirements.txt
              cd build_scripts
              pyinstaller build_windows.spec
              if ($LASTEXITCODE -ne 0) {
                Write-Host "PyInstaller failed!"
                if (Test-Path "build/build_windows/warn-build_windows.txt") {
                  Write-Host "=== Warnings ==="
                  Get-Content build/build_windows/warn-build_windows.txt
                }
                exit 1
              }
              cd ..
              New-Item -ItemType Directory -Force -Path dist | Out-Null
              if (Test-Path "build_scripts/dist/Ivory.exe") {
                Move-Item -Force build_scripts/dist/Ivory.exe "dist/Ivory-Windows-v$env:VERSION.exe"
              } else {
                Write-Host "ERROR: Ivory.exe not found in build_scripts/dist/"
                Write-Host "Contents of build_scripts/dist/:"
                Get-ChildItem build_scripts/dist/ | Select-Object Name
                exit 1
              }

          - os: macos-latest
            platform: macos
            build_command: |
              pip install -r build_scripts/requirements.txt
              cd build_scripts
              pyinstaller build_macos.spec || {
                echo "PyInstaller failed!"
                if [ -f "build/Ivory/warn-Ivory.txt" ]; then
                  echo "=== Warnings ==="
                  cat build/Ivory/warn-Ivory.txt
                fi
                exit 1
              }
              cd ..
              mkdir -p dist
              if [ -d "build_scripts/dist/Ivory.app" ]; then
                cd build_scripts/dist
                zip -r ../../dist/Ivory-macOS-v${VERSION}.zip Ivory.app
                cd ../..
              else
                echo "ERROR: Ivory.app not found in build_scripts/dist/"
                echo "Contents of build_scripts/dist/:"
                ls -la build_scripts/dist/
                exit 1
              fi

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r build_scripts/requirements.txt

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build for ${{ matrix.platform }}
        run: ${{ matrix.build_command }}
        shell: ${{ runner.os == 'Windows' && 'pwsh' || 'bash' }}
        env:
          VERSION: ${{ steps.get_version.outputs.VERSION }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-build
          path: dist/*

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Move artifacts to dist
        run: |
          mkdir -p dist
          find artifacts -type f \( -name "*.deb" -o -name "*.exe" -o -name "*.zip" \) -exec mv {} dist/ \;

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Ivory ${{ steps.get_version.outputs.VERSION }}
          body_path: RELEASE_${{ steps.get_version.outputs.VERSION }}.md
          draft: false
          prerelease: false
          files: |
            dist/*
            screenshots/*.png
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
